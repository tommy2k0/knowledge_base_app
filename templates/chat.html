{% extends "base.html" %}

{% block title %}Chat - AI Knowledge Base{% endblock %}

{% block content %}
<div class="h-screen flex">
    <!-- Sidebar: Chat Sessions -->
    <aside class="w-80 bg-gray-800 border-r border-gray-700 flex flex-col">
        <!-- Header -->
        <div class="p-4 border-b border-gray-700">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-xl font-bold text-blue-500">ðŸ’¬ Chat Sessions</h2>
                <button onclick="createNewSession()" 
                        class="p-2 bg-blue-600 hover:bg-blue-700 rounded-lg transition">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                    </svg>
                </button>
            </div>
            <!-- User Info -->
            <div class="flex items-center justify-between text-sm">
                <span class="text-gray-400">{{ user.username }}</span>
                <a href="/logout" class="text-red-400 hover:text-red-300">Logout</a>
            </div>
        </div>

        <!-- Sessions List -->
        <div id="sessions-list" 
             class="flex-1 overflow-y-auto custom-scrollbar p-2">
            <!-- Sessions loaded here -->
        </div>
    </aside>

    <!-- Main Chat Area -->
    <main class="flex-1 flex flex-col">
        <!-- Chat Header -->
        <header class="bg-gray-800 border-b border-gray-700 p-4 flex items-center justify-between">
            <div>
                <h1 id="chat-title" class="text-xl font-semibold">Select or create a chat session</h1>
                <p class="text-sm text-gray-400">AI-powered knowledge assistant with RAG</p>
            </div>
            <a href="/articles" class="px-4 py-2 bg-gray-700 hover:bg-gray-600 rounded-lg transition">
                ðŸ“š Browse Articles
            </a>
        </header>

        <!-- Messages Container -->
        <div id="messages-container" 
             class="flex-1 overflow-y-auto custom-scrollbar p-6 space-y-4">
            <!-- Welcome message -->
            <div class="text-center text-gray-400 mt-20">
                <svg class="w-16 h-16 mx-auto mb-4 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z"/>
                </svg>
                <p class="text-lg">Welcome to your AI Knowledge Base!</p>
                <p class="text-sm mt-2">Create a new session or select an existing one to start chatting</p>
            </div>
        </div>

        <!-- Message Input -->
        <div id="message-input-container" class="hidden p-4 border-t border-gray-700 bg-gray-800">
            <form id="message-form" class="flex gap-3">
                <input type="text" 
                       id="message-input"
                       name="message"
                       placeholder="Ask anything about your knowledge base..."
                       class="flex-1 px-4 py-3 bg-gray-700 border border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-white placeholder-gray-400"
                       required>
                <button type="submit"
                        class="px-6 py-3 bg-blue-600 hover:bg-blue-700 text-white font-semibold rounded-lg transition duration-200 flex items-center gap-2">
                    <span>Send</span>
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 5l7 7-7 7M5 5l7 7-7 7"/>
                    </svg>
                </button>
            </form>
        </div>
    </main>
</div>

<script>
    let currentSessionId = null;

    // Create new session
    async function createNewSession() {
        const title = prompt('Enter session title:', 'New Chat Session');
        if (!title) return;

        const response = await fetch('/api/v1/chat/sessions', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ title })
        });

        if (response.ok) {
            const session = await response.json();
            loadSession(session.id);
            loadSessions();
        }
    }

    // Load session
    async function loadSession(sessionId) {
        currentSessionId = sessionId;
        
        // Load messages
        const response = await fetch(`/api/v1/chat/sessions/${sessionId}/messages`);
        const messages = await response.json();
        
        // Display messages
        const container = document.getElementById('messages-container');
        container.innerHTML = messages.map(msg => renderMessage(msg)).join('');
        
        // Show input
        document.getElementById('message-input-container').classList.remove('hidden');
        
        // Update title
        const sessionsResponse = await fetch(`/api/v1/chat/sessions/${sessionId}`);
        const session = await sessionsResponse.json();
        document.getElementById('chat-title').textContent = session.title;
        
        // Scroll to bottom
        container.scrollTop = container.scrollHeight;
    }

    async function loadSessions() {
        const response  = await fetch('/api/v1/chat/sessions');
        const sessions  = await response.json();

        const container = document.getElementById('sessions-list');

        if (sessions.length === 0) {
            container.innterHTML = '<p class="text-gray-500 text-center p-4">No sessions yet</p>';
            return;
        }

        container.innerHTML = sessions.map(session => `
            <button onclick="loadSession(${session.id})"
                    class="w-full text-left p-3 rounded-lg hover:bg-gray-700 transition mb-2 ${currentSessionId === session.id ? 'bg-gray-700' : ''}">
                <div class="font-medium text-white">${session.title}</div>
                <div class="text-xs text-gray-400">${new Date(session.created_at).toLocaleDateString()}</div>
            </button>
        `).join('');
    }

    // Render message
    function renderMessage(msg) {
        const isUser = msg.role === 'user';
        const bgColor = isUser ? 'bg-blue-600' : 'bg-gray-700';
        const alignment = isUser ? 'justify-end' : 'justify-start';
        
        let sourcesHtml = '';
        if (msg.sources && msg.sources.length > 0) {
            const sources = typeof msg.sources === 'string' ? JSON.parse(msg.sources) : msg.sources;
            sourcesHtml = `
                <div class="mt-2 pt-2 border-t border-gray-600 text-xs text-gray-400">
                    ðŸ“š Sources: Article IDs ${sources.join(', ')}
                </div>
            `;
        }
        
        return `
            <div class="flex ${alignment}">
                <div class="${bgColor} rounded-lg px-4 py-3 max-w-2xl">
                    <p class="text-white whitespace-pre-wrap">${msg.content}</p>
                    ${sourcesHtml}
                </div>
            </div>
        `;
    }

    // Send message
    document.getElementById('message-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        if (!currentSessionId) return;
        
        const input = document.getElementById('message-input');
        const message = input.value.trim();
        if (!message) return;
        
        // Clear input and add user message immediately
        input.value = '';
        const container = document.getElementById('messages-container');
        container.innerHTML += renderMessage({ role: 'user', content: message });
        container.scrollTop = container.scrollHeight;
        
        // Show loading indicator
        const loadingHtml = `
            <div class="flex justify-start">
                <div class="bg-gray-700 rounded-lg px-4 py-3">
                    <div class="flex gap-2">
                        <div class="w-2 h-2 bg-blue-500 rounded-full animate-bounce"></div>
                        <div class="w-2 h-2 bg-blue-500 rounded-full animate-bounce" style="animation-delay: 0.1s"></div>
                        <div class="w-2 h-2 bg-blue-500 rounded-full animate-bounce" style="animation-delay: 0.2s"></div>
                    </div>
                </div>
            </div>
        `;
        container.innerHTML += loadingHtml;
        container.scrollTop = container.scrollHeight;
        
        // Send message
        const response = await fetch(`/api/v1/chat/sessions/${currentSessionId}/messages`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ message })
        });
        
        if (response.ok) {
            const data = await response.json();
            // Remove loading indicator
            container.removeChild(container.lastChild);
            // Add AI response
            container.innerHTML += renderMessage(data.message);
            container.scrollTop = container.scrollHeight;
        }
    });

    // Initial load of sessions
    loadSessions();
</script>
{% endblock %}
